#!/bin/bash
set -e

# Post-installation script for lunasched v1.4.0

# Create lunasched user if it doesn't exist (needed for job execution)
if ! id "lunasched" &>/dev/null; then
    useradd -r -s /bin/false -d /var/lib/lunasched -M lunasched
fi

# Create directory structure
mkdir -p /var/lib/lunasched
mkdir -p /var/log/lunasched
mkdir -p /var/run/lunasched
mkdir -p /etc/lunasched

# Set ownership and permissions
# Note: Daemon runs as root but jobs execute as lunasched user via sudo
chown root:root /var/lib/lunasched
chmod 755 /var/lib/lunasched

chown root:root /var/log/lunasched
chmod 755 /var/log/lunasched

# Socket directory needs to be accessible by all users for CLI communication
chown root:root /var/run/lunasched
chmod 755 /var/run/lunasched

# Config directory readable by all
chown root:root /etc/lunasched
chmod 755 /etc/lunasched

if [ -f /etc/lunasched/config.yaml ]; then
    chown root:root /etc/lunasched/config.yaml
    chmod 644 /etc/lunasched/config.yaml
fi

# Set permissions on sudoers file (must be 440)
if [ -f /etc/sudoers.d/lunasched ]; then
    chown root:root /etc/sudoers.d/lunasched
    chmod 440 /etc/sudoers.d/lunasched
fi

# Reload systemd and enable service
if [ -d /run/systemd/system ]; then
    systemctl daemon-reload || true
    systemctl enable lunasched.service || true
    systemctl restart lunasched.service || true
    
    echo ""
    echo "=========================================="
    echo "Lunasched v1.4.0 installed successfully!"
    echo "=========================================="
    echo ""
    echo "Config: /etc/lunasched/config.yaml"
    echo "Docs:   /usr/share/doc/lunasched/"
    echo ""
    echo "=========================================="
    echo ""
fi
